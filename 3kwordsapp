import streamlit as st
import pandas as pd, numpy as np, time, random
from sqlalchemy import create_engine

# â€”â€”â€” 1) Load data & DB â€”â€”â€”
@st.cache
def load_vocab():
    return pd.read_csv("data/vocab.csv")

vocab = load_vocab()
engine = create_engine("sqlite:///progress.db")   # stores scores

# â€”â€”â€” 2) Initialization â€”â€”â€”
if "set_idx" not in st.session_state:
    st.session_state.set_idx  = 0
    st.session_state.score    = 0
    st.session_state.phase    = "intro"   # intro | reading | quiz | review

# â€”â€”â€” 3) Helpers â€”â€”â€”
def pick_next_set():
    return vocab.sample(10, replace=False).reset_index(drop=True)

if "current_set" not in st.session_state:
    st.session_state.current_set = pick_next_set()

# â€”â€”â€” 4) Phase: Intro â€”â€”â€”
if st.session_state.phase == "intro":
    st.title("ğŸ”¤ Englishâ€“Polish Speed-Quiz")
    st.write("Ready to gobble up 10 new words in a minute? Press â–¶ï¸ Start.")
    if st.button("â–¶ï¸ Start reading"):
        st.session_state.phase     = "reading"
        st.session_state.start_time = time.time()
        st.experimental_rerun()

# â€”â€”â€” 5) Phase: Reading â€”â€”â€”
elif st.session_state.phase == "reading":
    elapsed = time.time() - st.session_state.start_time
    st.write(f"â±ï¸ Reading time: {int(60-elapsed)}s left")
    cols = st.columns(2)
    for i, row in st.session_state.current_set.iterrows():
        cols[i % 2].markdown(f"**{row.english}** â€” {row.polish}")
    st.progress(elapsed/60)
    if elapsed >= 60:
        st.session_state.phase = "quiz"
        st.experimental_rerun()
    else:
        st.experimental_rerun()

# â€”â€”â€” 6) Phase: Quiz â€”â€”â€”
elif st.session_state.phase == "quiz":
    st.write("Match each **Polish** word to its **English** buddy.")
    answers = {}
    options = list(st.session_state.current_set.polish)
    for idx, eng in enumerate(st.session_state.current_set.english):
        answers[idx] = st.selectbox(f"{eng} â†’", [""] + options, key=f"q{idx}")
    if st.button("Submit answers"):
        correct = 0
        for idx, choice in answers.items():
            if choice == st.session_state.current_set.loc[idx, "polish"]:
                correct += 1
        st.session_state.score += correct
        # log progress
        pd.DataFrame({
            "timestamp": [pd.Timestamp.now()],
            "set":       [st.session_state.set_idx],
            "correct":   [correct]
        }).to_sql("progress", engine, if_exists="append", index=False)
        st.session_state.phase = "review"
        st.session_state.correct = correct
        st.experimental_rerun()

# â€”â€”â€” 7) Phase: Review & Next â€”â€”â€”
elif st.session_state.phase == "review":
    st.write(f"âœ… You got **{st.session_state.correct}/10** this round.")
    st.write(f"ğŸ† Total score: **{st.session_state.score}**")
    if st.button("Next 10 words"):
        st.session_state.set_idx   += 1
        st.session_state.current_set = pick_next_set()
        st.session_state.phase     = "reading"
        st.session_state.start_time = time.time()
        st.experimental_rerun()
